<!DOCTYPE html>
    <html lang = "en" class="tas-com">
<head>
	<meta charset="utf-8">
	<title>Assignment 2</title>
	<link href="./themes/prism.css" rel="stylesheet" />
	<link href="./themes/tas_style.css" rel="stylesheet" />
	<script src="https://d3js.org/d3.v5.min.js"></script>
	<script src="./lib/prism.js" charset="utf-8"></script>
    <script type="text/javascript" src="./d3/d3.v4.js" charset="utf-8"></script>
    <style type="text/css">
		.axis path,
		.axis line {
		    fill: none;
		    stroke: black;
		    shape-rendering: crispEdges;
		}
		
		.axis text {
		    font-family: sans-serif;
		    font-size: 11px;
		}	
	</style>
</head>

<body>
    
    <h1 id="year_header">Year:</h1>

    <script type="text/javascript">
        
        // margins
        var margin = {top: 50, right: 60, bottom: 50, left:80};
        
        // width and height
        var outer_width = 1050;
        var outer_height = 750

        var svg_width = outer_width - margin.left - margin.right;
        var svg_height = outer_height - margin.top - margin.bottom;
        
        display_year = 2007;
        
        function yearFilter(value){
            return (value.Year == display_year)
        }
        
        // the global dataset object
        var dataset;
        
        xScale = d3.scaleLinear().range([0, svg_width]);
        
        rScale = d3.scaleSqrt().range([0, 5]);
        
        yScale = d3.scaleLinear().range([svg_height, 0]);
        
        
        
        // x-axis connected to the x scale
        var xAxis = d3.axisBottom().scale(xScale).ticks(10);
        
        //define y-axis
        var yAxis = d3.axisLeft().scale(yScale).ticks(10);
        
        
        
        // Create an svg element
        
        var svg = d3.select("body")
                    .append("svg")
                    .attr("width", svg_width + margin.left + margin.right)
			         .attr("height", svg_height + margin.top + margin.bottom)
			         .append("g")
			         .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        
        var colorCircles = d3.scaleOrdinal(d3.schemeCategory10);
        
        function generateVis(){
            
            var filtered_dataset = dataset.filter(yearFilter);
            
            /**********DATA JOIN************/
            var points = svg.selectAll("circle")
                            .data(filtered_dataset);
            
            /**********UPDATE SELECTION************/
             
            points
                .attr("cx", function(d,i){
                    return xScale(d.GDP);
            })
                .attr("cy", function(d){
                    return yScale(d.Global_Competitiveness_Index);
            })
                .transition()
                .attr("r", function(d){
                    return rScale(d.Population);
            })
                .style("fill", function(d) { return colorCircles(d.category)})
                .style("fill-opacity", .2)
                //.style("stroke", "red");
            
            /**********ENTER SELECTION************/
            points
                .enter()
                    .append("circle")
                        .attr("cx", function(d,i){
                            return xScale(d.GDP);
                        })
                        .attr("cy", function(d){
                            return yScale(d.Global_Competitiveness_Index);
                        })
                        .transition()
                        .attr("r", function(d){
                            return rScale(d.Population);
                        })
                        .style("fill", colorCircles(3))
                        .style("fill-opacity", .2)
                        //.style("stroke", "red");
            
            
            /**********EXIT SELECTION************/
            
            points.exit().remove();
            
            d3.select("#year_header").text("Year: " + display_year)
}
        
        //loaing the data file
        d3.csv("./GCI_CompleteData2.csv", function(error, data){
//            handle loading errors
//            if(error){
//                console.log("something went wrong");
//                console.log(error);
//            }
//            else{
                console.log("data loaded")
                
                dataset = data;
                
                var max_population = d3.max(dataset, function(d){return d.Population    ;} );
                var min_GDP = d3.min(dataset, function(d) { return d.GDP;} );
                var max_GDP = d3.max(dataset, function(d) { return d.GDP;} );
                var max_Global_Competitiveness_Index = d3.max(dataset, 
                function(d){return d.Global_Competitiveness_Index});
                
                
                xScale.domain([min_GDP, 600000]);
                yScale.domain([0, max_Global_Competitiveness_Index]);
                rScale.domain([0, max_population]);
                
                
                //create x-axis
                svg.append("g")
                    .attr("class", "axis")
                    .attr("id", "x-axis")
                    .attr("transform", "translate(0," + svg_height + ")")
                    .call(xAxis);
                
                //create the y axis
                svg.append("g")
				.attr("class", "axis")
				.attr("id", "y-axis")
				.call(yAxis)
				.append("text")
				      .attr("transform", "rotate(-90)")
				      .attr("y", 6)
				      .attr("dy", ".71em")
				      .style("text-anchor", "end")
				      .text("Global_Competitiveness_Index");
                
                generateVis();
                
                // set up an interval callback to refresh the visuaslaition every second
			setInterval(function() {
                display_year = display_year + 1;
                if(display_year > 2017){
                    display_year = 2017;
                }

				
                generateVis();
				}, 1000);
                
                
//            }
        });
            
        
    </script>

    </body>
</html>