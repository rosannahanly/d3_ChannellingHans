<!DOCTYPE html>
<html lang="en">
    <style>
        div.tooltip {
            position: absolute;
            text-align: center;
            width: 70px;
            height: 50px;
            padding: 2px;
            font: 12px sans-serif;
            background: lightgray;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }
    </style>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Part 2</title>
    <script></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- <link rel="stylesheet" type="text/css" media="screen" href="main.css" /> -->
    <link href="./themes/prism.css" rel="stylesheet" />
	<link href="./themes/tas_style.css" rel="stylesheet" />
	<script src="https://d3js.org/d3.v5.min.js"></script>
	<script src="./lib/prism.js" charset="utf-8"></script>
    <script type="text/javascript" src="./d3/d3.v4.js" charset="utf-8"></script>
    <script src="https://d3js.org/d3.v5.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.core.js"></script>
    
    
    <style>
    .my-legend .legend-title {
    text-align: left;
    margin-bottom: 8px;
    margin-left: 10px;
    font-weight: bold;
    font-size: 90%;
    font-family: 'Calibri';
    }
  .my-legend .legend-scale ul {
    margin: 0;
    padding: 0;
    float: left;
    list-style: none;
    }
  .my-legend .legend-scale ul li {
    display: block;
    float: left;
    width: 90px;
    height: 60px;
    margin-bottom: 6px;
    margin-left: 10px;
    text-align: left;
    font-size: 80%;
    list-style: none;
    color: black;
    font-family: 'Calibri';
    }
  .my-legend ul.legend-labels li span {
    display: block;
    float: left;
    height: 15px;
    width: 15px;
    border-radius: 50%;
    }
  .my-legend {
    color: grey;
    }
    
    </style>
    
</head>
<body>
<h4>Created by Sophie Heseltine and Rosanna Hanly</h4>

<div class="container">
    <p id="hans">
    </p>
    <!--This is where the control buttons are for first graph-->
    <div class="row">
        <div class="col-xs-12">
            <div class="row">
                <div class="col-xs-4">
                    <!-- I think this button needs to be moved -->
                    <button type="button" class="btn btn-success" id="playPause"><span class="glyphicon glyphicon-play"></span></button>
                    <h3 id ="year_header" style="margin-top: 0;">Year: </h3>
                    <div class="col-xs-4">
                            <input list="yearDropDown" id = "yearDropDownInput" placeholder="2007">
                            <datalist id="yearDropDown">
        
                            </datalist>
                        </div>
                </div>
                <div class="col-xs-8">
                    <input list="countryDropDown" name = "browser" id = "countryDropDownInput" placeholder="Select Country">
                    <datalist id="countryDropDown">

                    </datalist>
                    <button type="button" class="btn btn-primary" id="traceButton"><span>Show Trace</span></button>
                </div>
            </div>
            <!-- This is where the first graph goes -->
            <h2 id="part1"></h2>
        </div>
    </div>
    <!--Legend for the first graph-->
    <div class='my-legend'>
        <div class='legend-title'>Legend</div>
        <div class='legend-scale'>
            <ul class='legend-labels'>
                <li><span style='background-color:blue; opacity:0.7'></span><br>Europe and North America</li>
                <li><span style='background-color:red; opacity: 0.7'></span><br>Middle East and North Africa</li>
                <li><span style='background-color:rgb(249, 217, 42); opacity: 0.7'></span><br>Sub-Saharan Africa</li>
                <li><span style='background-color:green; opacity: 0.7'></span><br>Latin America and the Caribbean</li>
                <li><span style='background-color:purple; opacity: 0.7'></span><br>Eurasia</li>
                <li><span style='background-color:pink; opacity: 0.7'></span><br>East Asia and Pacific</li>
                <li><span style='background-color:orange; opacity: 0.7'></span><br>South Asia</li>
            </ul>
        </div>
    </div>
    <br>
    <br>
    <br>
    <div class="row">
        <div id="secondvis">
            <h2>Select two countries to compare their pillars of competitiveness</h2></div></div>
    
    <!--The control buttons for the second visualisation-->
    <div class="row">
        <div class="col-xs-6">
            <input list="countryDropDown" id="countryDropDownInputLeft" placeholder="Select Country One">
            <datalist id="countryDropDxown">
            </datalist>
            <button type="button" class="btn btn-primary" id="showPillarsButtonLeft"><span>Show Country</span></button>
            
            
        </div>
        <div class="col-xs-6">
                <input list="countryDropDown" id="countryDropDownInputRight" placeholder="Select Country One">
                <datalist id="countryDropDown">
                </datalist>
                <button type="button" class="btn btn-primary" id="showPillarsButtonRight"><span>Show Country</span></button>
            </div>

    </div>
    <!--This is where the second visualisation will go-->
    <h2 id="part2"></h2>
</div>





    
</body>
<script>

    let playing = false;
    $("#playPause").on("click", function(){
        playing = !playing;
        if (playing){
            $('#playPause').addClass('btn-danger').removeClass('btn-success');
            $('#playPause span').addClass('glyphicon-pause').removeClass('glyphicon-play');
            //$('#playPauseButton p').text("Pause"); 
        }
        else {
            $('#playPause').addClass('btn-success').removeClass('btn-danger');
            $('#playPause span').addClass('glyphicon-play').removeClass('glyphicon-pause');
            //$('#playPauseButton p').text("Play"); 
        }
    });

    let year = 2007;
    //let dataset = {};
    document.getElementById("yearDropDownInput").oninput = function(){
        console.log("Years are working!!")
        display_year=+this.value;
        d3.select("#year_header").text("Year: " + display_year)
        generateVis(dataset, false)
        generateVisPillars(dataset)
        generateVisPillars(dataset, "right");
    };

    var showingTrace = false;
    var country = "";
    $('#traceButton').on("click", function(){
        country = $('#countryDropDownInput').val();
        if(country == "" && !showingTrace) return;
        showingTrace = !showingTrace;
        if(showingTrace){
            $('#traceButton').addClass('btn-danger').removeClass('btn-primary');
            $('#traceButton span').text("Hide Trace");
        } else {
            $('#traceButton').addClass('btn-primary').removeClass('btn-danger');
            $('#traceButton span').text("Show Trace"); 
        }
        generateVis(dataset, false);
    });
    
    
    //buttons for pillar visualisation
    let countryOneButtonClicked = false;
    let countryTwoButtonClicked = false;
    
    $('#showPillarsButtonLeft').on("click", function() {
        countryOneButtonClicked = true;
        let pillarsCompare = countryTwoButtonClicked;
        let country = $('#countryDropDownInputLeft').val();
        console.log(country + "country");
        if (country == "") return;
        generateVisPillars(dataset);
        console.log(country + "left bars");
    });
    
    $('#showPillarsButtonRight').on("click", function() {
        countryTwoButtonClicked = true;
        let pillarsCompare = countryOneButtonClicked;
        let country = $('#countryDropDownInputRight').val();
        if (country == "") return;
        generateVisPillars(dataset, "right");
        console.log(country + "right bars");
    });



    // margins
    var margin = {top: 40, right: 60, bottom: 60, left:80};
        
    // width and height
    var outer_width = 1050;
    var outer_height = 500

    var svg_width = outer_width - margin.left - margin.right;
    var svg_height = outer_height - margin.top - margin.bottom;
        
    display_year = 2007;
    function yearFilter(value){
        return (value.Year == display_year)
    }

    function yearAndCountryFilter(value){
        return value.Country == country && +value.Year <= +display_year;
    }
    
    function yearAndCountryFilterP(value) {
        return yearFilter(value) && value.Country == country;
    }
        
    // the global dataset object
    var dataset;

    //Scaling the data so that it can be viewed on a graph    
    xScale = d3.scaleLog().domain([100, 2.4e6]).range([0, svg_width]);
    rScale = d3.scaleSqrt().range([0, 5]);
    yScale = d3.scaleLinear().domain([0,7]).range([svg_height, 0]);
               
    // x-axis connected to the x scale
    var xAxis = d3.axisBottom().scale(xScale).ticks(10, ".0s");
        
    //define y-axis
    var yAxis = d3.axisLeft().scale(yScale).ticks(5).tickFormat(d3.format(".0s"));
           
    var div = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

    // Create an svg element
    var svg = d3.select("#part1")
        .append("svg")
        .attr("width", svg_width + margin.left + margin.right)
		.attr("height", svg_height + margin.top + margin.bottom)
		.append("g")
		.attr("transform", "translate(" + margin.left + "," + margin.top + ")")
        ;

function generateVis(){
            
            var filtered_dataset = dataset.filter(yearFilter);
            
            /**********DATA JOIN************/
            var points = svg.selectAll("circle")
                            .data(filtered_dataset, function key(d){
                                return d.Country;
                            });
            
            /**********UPDATE SELECTION************/
             
            points.transition().duration(2000)
                .attr("cx", function(d,i){ return xScale(+d.GDP); })
                .attr("cy", function(d){ return yScale(+d.Global_Competitiveness_Index); })
                .attr("r", function(d){ return rScale(+d.Population); })
                .style("fill-opacity", function(d){
                    if(showingTrace) return .3;
                    else return .5;
                })
                .style("fill", function(d) 
                {
                region = d.Forum_classification
                if (region === "Europe and North America") {
                    return "blue"
                }
                else if (region === "Middle East and North Africa") {
                    return "red"
                }
                else if (region === "Sub-Saharan Africa") {
                    return "rgb(249, 217, 42)"
                }
                else if (region === "Latin America and the Caribbean") {
                    return "green"
                }
                else if (region === "Eurasia") {
                    return "purple"
                }
                else if (region === "East Asia and Pacific") {
                    return "pink"
                }
                else if (region === "South Asia") {
                    return "orange"
                }
            });

            if (showingTrace){
                country = $('#countryDropDownInput').val();
                let selectedCountry = dataset.filter(yearAndCountryFilter);
                console.log(selectedCountry);
                let tracePoints = svg.selectAll("#circle_trace")
                    .data(selectedCountry, function key(d){
                        return d.Country;
                    });
                let traceEnter = tracePoints.enter()
                    .append("circle")
                    .attr("id", function(d){
                        return "circle_trace"
                    })
                    .attr("cx", function(d,i){ return xScale(+d.GDP); })
                    .attr("cy", function(d){ return yScale(+d.Global_Competitiveness_Index); })
                    .attr("r", function(d){ return rScale(+d.Population); })
                    .style("fill-opacity", function(d){
                        return 0.8;
                    })
                    .style("stroke", "black")
                    .style("fill", function(d) {
                        region = d.Forum_classification
                        if (region === "Europe and North America") {
                            return "blue"
                        }
                        else if (region === "Middle East and North Africa") {
                            return "red"
                        }
                        else if (region === "Sub-Saharan Africa") {
                            return "rgb(249, 217, 42)"
                        }
                        else if (region === "Latin America and the Caribbean") {
                            return "green"
                        }
                        else if (region === "Eurasia") {
                            return "purple"
                        }
                        else if (region === "East Asia and Pacific") {
                            return "pink"
                        }
                        else if (region === "South Asia") {
                            return "orange"
                        }
                    });

            }
                        
            /**********ENTER SELECTION************/
            points
                .enter()
                    .append("circle")
                    .attr("cx", function(d,i){ return xScale(d.GDP); })
                .attr("cy", function(d){ return yScale(d.Global_Competitiveness_Index);})
                .attr("r", function(d){ return rScale(d.Population);})
                .style("fill", function(d) 
                {
                region = d.Forum_classification
                if (region === "Europe and North America") {
                    return "blue"
                }
                else if (region === "Middle East and North Africa") {
                    return "red"
                }
                else if (region === "Sub-Saharan Africa") {
                    return "rgb(249, 217, 42)"
                }
                else if (region === "Latin America and the Caribbean") {
                    return "green"
                }
                else if (region === "Eurasia") {
                    return "purple"
                }
                else if (region === "East Asia and Pacific") {
                    return "pink"
                }
                else if (region === "South Asia") {
                    return "orange"
                }
                
            })
            .style("fill-opacity", .5)
            .append("title").text(function(d, i) {return d.Country });
          /**********EXIT SELECTION************/
            
            points.exit().remove();
            
            d3.select("#year_header").text("Year: " + display_year)
            
        
}

// loading in Data     
d3.csv("./GCI_CompleteData4.csv").then(function(data){
    dataset=data;
    handleData(dataset);
}, function(error) {
    console.log("Error loading data")
    console.log(error);
    document.getElementById("hans").innerHTML += "<br/><span>Error Loading in data</span>"
});
function handleData(dataset){
    // Create the scales and call the axis
    makeScales(dataset);
    createAxis();
    createYearText();
    createPillarsXAxis();
    // Generate the initial visualisation
    generateVis(dataset);
    generateVisPillars(dataset);
    generateVisPillars(dataset, "right");
    //populate country dropdown
    populateCountryDropDown(dataset);
    populateYearDropDown(dataset);
    setInterval(function(){
        if (playing) {
            display_year = display_year +1;
            if(display_year >2017){
                display_year =2007;
            }
            generateVis();
            document.getElementById("yearDropDown").value = display_year;
            generateVisPillars(dataset);
            generateVisPillars(dataset, "right");
        }
    }, 2000);
}

function makeScales(data){
    dataset = data;
                
    var max_population = d3.max(dataset, function(d){return d.Population    ;} );
    var min_GDP = d3.min(dataset, function(d) { return +d.GDP;} );
    var max_GDP = d3.max(dataset, function(d) { return +d.GDP;} );
    var max_Global_Competitiveness_Index = d3.max(dataset, 
    function(d){return d.Global_Competitiveness_Index});
                
    xScale.domain([90, max_GDP+20]);
    yScale.domain([0, max_Global_Competitiveness_Index]);
    rScale.domain([0, max_population]);
}
   
function createYearText(){
    svg.append("text")
        .attr("id", "year_header")
        .attr("x", "200")
        .attr("y", "200")
    .text(year_header);
        ;
}

function createAxis(){
    //create x-axis
    svg.append("g")
        .attr("class", "axis")
        .attr("id", "x-axis")
        .attr("transform", "translate(0," + svg_height + ")")
        .call(xAxis)
        .append("text")
        .text("GDP")
        .attr("dy", "3em")
        .attr("dx", "20em")
        .style("fill", "grey")
        .style("font-weight", "bold")
        .style("font-size", "14pt");
                
    //create the y axis
    svg.append("g")
	    .attr("class", "axis")
		.attr("id", "y-axis")
		.call(yAxis)
		.append("text")
		.attr("transform", "rotate(-90)")
//	    .attr("y", 6)
		.attr("dy", "-3em")
        .attr("dx", "-4em")
//		.style("text-anchor", "end")
        .style("fill", "grey")
		.text("Global_Competitiveness_Index")
        .style("font-weight", "bold")
        .style("font-size", "14pt");
    
}

function populateCountryDropDown(data){
    let countries = new Set();
    _.forEach(data, function(row) {
        countries.add(row.Country) //adding each country to a set
    });
    for (let country of countries) {
        let countryDropDownUL = document.getElementById("countryDropDown");
        let option = document.createElement("option")
        option.setAttribute("value", country);
        countryDropDownUL.appendChild(option);
    };
}

function populateYearDropDown(data){
    let years = new Set();
    _.forEach(data, function(row){
        years.add(row.Year) //adding each year to a set
    });
    for (let year of years){
        let yearDropDownUL = document.getElementById("yearDropDown");
        let option = document.createElement("option")
        option.setAttribute("value", year);
        yearDropDownUL.appendChild(option);
    };
}

var svgPillars = d3.select("#part2")
            .append("svg")
            .attr("width", svg_width + margin.left + margin.right)
            .attr("height", svg_height + margin.top + margin.bottom)
            .style("background", "white")
            //.style("width", "80vw")
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var x = [];
function createPillarsXAxis(data) {
    //console.log(dataset.columns);
    var columns = dataset.columns;
    for (i=0; i<columns.length; i++){
        if(columns[i].includes("pillar"))
            x.push(columns[i].split("_")[2]);
    }
    xScalePillar = d3.scaleBand().domain(x).rangeRound([0, svg_width], 0.1).paddingInner(0,1);
    xAxisPillar = d3.axisBottom()
    .scale(xScalePillar)
    .ticks(10, ".0s");
}

svgPillars.append("g")
    .attr("class", "axis")
    .attr("id", "x-axisP")
    .attr("transform", "translate(0," + svg_height + ")")
    .append("text")
        .text("Pillars of Global Competitiveness")
        .attr("dy", "3em")
        .attr("dx", "25em")
        .style("fill", "grey")
        .style("font-weight", "bold")
        .style("font-size", "14pt");

svgPillars.append("g")
    .attr("class", "axis")
    .attr("id", "y-axis")
    .call(yAxis)
    .append("text")
		.attr("transform", "rotate(-90)")
//	    .attr("y", 6)
		.attr("dy", "-3em")
        .attr("dx", "-6em")
//		.style("text-anchor", "end")
        .style("fill", "grey")
		.text("Pillar Score")
        .style("font-weight", "bold")
        .style("font-size", "14pt");
    
    

function generateVisPillars(dataset, side="left"){
    //console.log("starting function");
    console.log(dataset[0]);
    country = side === "left" ? $('#countryDropDownInputLeft').val() : $('#countryDropDownInputRight').val(); 
    svgPillars.select('#x-axisP').call(xAxisPillar);
    let filtered_dataset = dataset.filter(yearAndCountryFilterP);
    let twelvePillars = [];
    if (typeof filtered_dataset[0] !== 'undefined') {
        twelvePillars = Object.entries(filtered_dataset[0]).slice(2,14);
        console.log(twelvePillars);
        filtered_dataset = twelvePillars;
    }
    
    if (side === "left") {
        /*******PERFORM DATA JOIN*******/
        let leftBars = svgPillars.selectAll('#leftBars')
            .data(filtered_dataset, function key(d) {
            return d[0].split('_'[2]);
        });
        
        /******** UPDATE SELECTION*********/
        
        
        leftBars
            .transition()
            .duration(2000)
            .attr("x", function(d,i) {
                  return xScalePillar(d[0].split('_')[2]);
                  })
            .attr("y", function(d) {
            return yScale(+d[1]);
            })
            .attr("width", xScalePillar.bandwidth()/2)
            .attr("height", function(d) {
            return svg_height - yScale(+d[1]);
            })
            .style("fill", "rgb(158, 202, 225)")
        
        
        leftBars.enter()
            .append("rect")
            .attr("id", function(d) {
            return "leftBars";
            })
            .attr("x", function(d,i) {
            return xScalePillar(d[0].split('_')[2]);
            })
            .attr("y", function(d) {
            return yScale(+d[1]);
            })
            .attr("width", xScalePillar.bandwidth()/2)
            .attr("height", function(d) {
            return svg_height - yScale(+d[1]);
            })
            .style("fill", "rgba(158, 202, 225, 0.7)")
            .transition()
            .duration(2000);
        
        
        leftBars.exit()
            .transition()
            .duration(2000)
            .attr("width", 0)
            .remove();
    }
    
    
    //right bars
    /*****DATA JOIN****/
    else {
        let rightBars = svgPillars.selectAll('#rightBars')
            .data(filtered_dataset, function key(d) {
                return d[0].split('_')[2];
            });
        
        /****HANDLE UPDATE SELECTION*****/
        rightBars
            .transition()
            .duration(2000)
            .attr("x", function(d,i){
            let xPos = xScalePillar(d[0].split('_')[2]);
            return xPos + xScalePillar.bandwidth()/2;
            })
            .attr("y", function(d) {
            return yScale(+d[1]);
            })
            .attr("width", xScalePillar.bandwidth()/2)
            .attr("height", function(d) {
            return svg_height - yScale(+d[1]);
            })
            .style("fill", "rgb(49, 130, 189)");
        
        
        rightBars.enter()
            .append("rect")
            .attr("id", function(d) {
            return "rightBars";
            })
            .attr("x", function(d,i){
            let xPos = xScalePillar(d[0].split('_')[2]);
            return xPos + xScalePillar.bandwidth()/2;
            })
            .attr("y", function(d) {
            return yScale(+d[1]);
            })
            .attr("width", xScalePillar.bandwidth()/2)
            .attr("height", function(d) {
            return svg_height - yScale(+d[1]);
            })
            .style("fill", "rgb(49, 130, 189)");
        
        /****EXIT SELECTION****/
        
        rightBars.exit()
            .transition()
            .duration(2000)
            .attr("width", 0)
            .remove();
    }
}


</script>
</html>